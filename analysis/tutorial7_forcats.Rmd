---
title: "Tutorial 6 - Machine Learning"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
---


# Top N queries in R


## Load Libraries


```{r,warning=FALSE,message=FALSE,echo=TRUE}

# load libraries
library(knitr)
opts_chunk$set(warning=F,message=F,fig.width = 11,fig.height = 5,cache=F, echo=T)
library(tidyverse)
library("RPostgreSQL")
library("forcats")

```
## Get data from SQL

```{r database_setup, echo=TRUE, warnings=FALSE, messages=FALSE}

# create connection to the database
con <- dbConnect(dbDriver("PostgreSQL"),
				 dbname   = 'vaed_full',
				 host = "himsql7.latrobe.edu.au", port = 5432,
				 user = "dewollershei-test", password = "healthGuru")
#
# this is the query to get all tne pneumonia diagnois.  the 3 commented lines would also finn the principal procedure
```

```{sql connection=con, output.var="morbidities"}

SELECT ad.position, ad_morbidity.diag_code, admission_id, age_years, los,
sameday_id, drg, sex_desc, diag_short_desc, sep_mode_desc, care_type_desc,
sep_mode_id
FROM admission JOIN sex USING (sex_id)
JOIN admission_diagnosis ad_morbidity USING (admission_id)
JOIN diagnosis_desc USING (diag_code)
JOIN admission_diagnosis ad_pneumonia USING (admission_id)
JOIN admission_procedure ap USING (admission_id)
JOIN separation_mode USING (sep_mode_id)
JOIN care_type USING (care_type_id)
WHERE ad_pneumonia.diag_code = 'J189'
AND ad_morbidity.position = 1
LIMIT 10

```

```{r}
#morbidities %>%
#  as_tibble() %>%
#  { . } -> morbidities

morbidities

```


# What are the top 5 morbidites of pneumonia

```{r top_5}


morbidities
#%>%
#  mutate( diag_short_desc = fct_lump_prop(diag_short_desc,0.10)) %>%
#  count( diag_short_desc, sort=TRUE)

```



